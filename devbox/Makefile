# –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ TAB –¥–ª—è –æ—Ç—Å—Ç—É–ø–æ–≤, –Ω–µ –ø—Ä–æ–±–µ–ª—ã!

.PHONY: run stop shell restart logs clean help

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
COMPOSE = docker compose
BUILDER = docker builder
CONTAINER = devbox

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make run	- –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
	@echo "  make stop	- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
	@echo "  make shell	- –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
	@echo "  make restart	- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
	@echo "  make logs	- –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
	@echo "  make clean	- –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –æ–±—Ä–∞–∑—ã"
	@echo "  make build	- –°–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
	@echo "  make status	- –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
	@echo "  make rebuild	- –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å, –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª"

run: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
	@echo "üîì –†–∞–∑—Ä–µ—à–∞–µ–º X11 –¥–æ—Å—Ç—É–ø..."
	@xhost +local:docker 2>/dev/null || xhost +local:root
	@echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
	@$(COMPOSE) up -d
	@echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make shell' –¥–ª—è –≤—Ö–æ–¥–∞"

stop: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
	@echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
	@$(COMPOSE) stop
	@echo "üîí –û—Ç–∑—ã–≤–∞–µ–º X11 –¥–æ—Å—Ç—É–ø..."
	@xhost -local:docker 2>/dev/null || true
	@echo "‚úÖ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

shell: ## –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
	@if ! $(COMPOSE) ps | grep -q "Up"; then \
		echo "‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å–∫–∞—é..."; \
		make run; \
	fi
	@echo "üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É..."
	@$(COMPOSE) exec --user dev -e DISPLAY=$(DISPLAY) $(CONTAINER) bash -lc "cd ~ && source ~/.profile && /entrypoint-log.sh; exec bash"

restart: ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
	@echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫..."
	@make stop
	@sleep 2
	@make run

logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
	@$(COMPOSE) logs -f $(CONTAINER)

clean: ## –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –æ–±—Ä–∞–∑—ã
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
	@$(COMPOSE) down -v --rmi all
	@echo "‚úÖ –û—á–∏—â–µ–Ω–æ"

build: ## –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑
	@echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞..."
	@$(COMPOSE) build --no-cache
	@$(BUILDER) prune --all --force
	@echo "‚úÖ –û–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω"

status: ## –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
	@echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
	@$(COMPOSE) ps

# –ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ (–∞–ª–∏–∞—Å –¥–ª—è shell)
sh: shell

# –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
rebuild: ## –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
	@make clean
	@make build
	@make run
	@make shell
